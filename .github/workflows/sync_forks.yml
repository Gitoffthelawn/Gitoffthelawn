name: Safe Sync Forks

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    steps:
      - name: Sync All Forks (Node.js Version)
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          cat << 'EOF' > sync.js
          const { execSync } = require('child_process');
          const fs = require('fs');

          async function run() {
            try {
              console.log("Fetching list of forks...");
              // Get user login
              const user = JSON.parse(execSync('gh api user').toString()).login;
              // Get all forks (handles pagination automatically via --paginate)
              const forksRaw = execSync(`gh api "users/${user}/repos?per_page=100" --paginate`).toString();
              
              // Handle potential concatenated JSON arrays from --paginate
              const forks = JSON.parse(forksRaw.replace(/\]\[/g, ','));
              const targetForks = forks.filter(f => f.fork === true);
              
              console.log(`Found ${targetForks.length} forks. Processing...`);

              let stats = { total: 0, synced: 0, noChange: 0, blocked: 0, failed: 0 };
              let tableRows = "| Repository | Status | Details |\n| :--- | :--- | :--- |\n";

              for (const fork of targetForks) {
                stats.total++;
                const name = fork.full_name;
                const mySize = fork.size;

                try {
                  // 1. Get Parent Info
                  const parentRaw = execSync(`gh api "repos/${name}" --silent`).toString();
                  const parent = JSON.parse(parentRaw).parent;

                  if (!parent) {
                    stats.failed++;
                    continue;
                  }

                  const parentSize = parent.size;
                  const threshold = mySize / 2;

                  // 2. Sanity Check
                  if (parentSize < threshold && mySize > 100) {
                    tableRows += `| ${name} | ðŸ›‘ **BLOCKED** | Parent size drop: ${parentSize}KB |\n`;
                    stats.blocked++;
                  } else {
                    // 3. Sync Attempt
                    try {
                      const syncOut = execSync(`gh repo sync "${name}" --force=false`).toString();
                      if (syncOut.includes("already up to date")) {
                        stats.noChange++;
                      } else {
                        tableRows += `| ${name} | âœ… Synced | Successfully updated |\n`;
                        stats.synced++;
                      }
                    } catch (syncErr) {
                      tableRows += `| ${name} | âŒ Failed | Conflict or Permission issue |\n`;
                      stats.failed++;
                    }
                  }
                } catch (e) {
                  stats.failed++;
                }

                // Heartbeat every 100 repos
                if (stats.total % 100 === 0) console.log(`Processed ${stats.total}...`);
                
                // 150ms delay to respect API
                await new Promise(r => setTimeout(r, 150));
              }

              // Build Summary
              const summary = `### ðŸ”„ Sync Activity Report\n` +
                `- **Total Forks:** ${stats.total}\n` +
                `- **Synced:** ${stats.synced} | **Blocked:** ${stats.blocked} | **Errors:** ${stats.failed}\n` +
                `- **Already Up-to-Date:** ${stats.noChange}\n\n` +
                (stats.synced > 0 || stats.blocked > 0 || stats.failed > 0 ? tableRows : "_No changes detected._");

              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
              console.log("Finished successfully.");

            } catch (err) {
              console.error("Critical Error:", err.message);
              process.exit(1);
            }
          }

          run();
          EOF

          node sync.js
