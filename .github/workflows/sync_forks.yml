name: "Sync Forks"

on:
  workflow_dispatch:

jobs:
  sync-all-forks:
    runs-on: ubuntu-latest
    steps:
      - name: "Sync All Forks via API"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const results = [];
            const stats = { synced: 0, upToDate: 0, blocked: 0, failed: 0 };
            
            console.log("ðŸ” Fetching repository list...");
            const allRepos = await github.paginate(github.rest.repos.listForAuthenticatedUser, {
              affiliation: 'owner',
              per_page: 100
            });
            
            const forks = allRepos.filter(r => r.fork === true);
            console.log(`ðŸš€ Found ${forks.length} forks. Processing...`);

            for (const fork of forks) {
              const fOwner = fork.owner.login;
              const fRepo = fork.name;
              let status = "Up-to-date";
              let detail = "";

              try {
                // Quota Check - Critical for your remaining 2,900 points
                const rate = await github.rest.rateLimit.get();
                if (rate.data.resources.core.remaining < 50) {
                  results.push(["SYSTEM", "âš ï¸ HALTED", "Quota Limit Reached"]);
                  break;
                }

                // Fetch fresh data for the Safety Check
                const { data: repoData } = await github.rest.repos.get({ owner: fOwner, repo: fRepo });
                
                if (repoData.parent) {
                  const pSize = repoData.parent.size;
                  const fSize = repoData.size;

                  if (pSize < (fSize / 2) && fSize > 100) {
                    status = "ðŸ›‘ BLOCK";
                    detail = `Upstream (${pSize}KB) < 50%`;
                    stats.blocked++;
                  } else {
                    try {
                      // Explicit body-payload format for maximum API compatibility
                      const syncResponse = await github.request('POST /repos/{owner}/{repo}/merge-upstream', {
                        owner: fOwner,
                        repo: fRepo,
                        data: {
                          branch: repoData.default_branch
                        }
                      });
                      
                      if (syncResponse.status === 200 || syncResponse.status === 204) {
                        status = "âœ… SYNC";
                        stats.synced++;
                      }
                    } catch (e) {
                      if (e.status === 409) {
                        stats.upToDate++;
                      } else { throw e; }
                    }
                  }
                } else { stats.upToDate++; }
              } catch (err) {
                status = "âŒ FAIL";
                detail = err.message.substring(0, 35);
                stats.failed++;
              }
              
              if (status !== "Up-to-date") {
                results.push([fork.full_name, status, detail]);
                // Log to console so you can watch live even if summary hasn't posted
                console.log(`[${stats.synced + stats.upToDate + stats.blocked + stats.failed}/${forks.length}] ${fork.full_name}: ${status}`);
              }
            }

            // Summary Table Generation
            const displayResults = results.slice(0, 1000);
            await core.summary
              .addHeading("ðŸ”„ Sync Report")
              .addRaw(`**Total Forks:** ${forks.length} | âœ… **Sync:** ${stats.synced} | âž– **Up-to-Date:** ${stats.upToDate} | ðŸ›‘ **Block:** ${stats.blocked} | âŒ **Err:** ${stats.failed}`)
              .addTable([
                [{data: 'Repo', header: true}, {data: 'Stat', header: true}, {data: 'Note', header: true}],
                ...displayResults
              ])
              .write();
