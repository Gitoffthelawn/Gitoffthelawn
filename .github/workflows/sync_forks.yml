name: Safe Sync Forks

on:
  schedule:
    - cron: '17 4 * * *' # Random time of 04_17 UTC to avoid peak traffic delays at 00_00 UTC
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # Long enough for 1400 repos, but prevents infinite hangs
    steps:
      - name: Sync All Forks
        env:
          MY_PAT: ${{ secrets.SYNC_TOKEN }}
        run: |
          cat << 'EOF' > sync.js
          const { execSync } = require('child_process');
          const fs = require('fs');

          async function run() {
            const token = process.env.MY_PAT;
            let stats = { total: 0, synced: 0, upToDate: 0, blocked: 0, failed: 0, consecutiveFailures: 0 };
            let tableRows = "| Repository | Status | Details |\n| :--- | :--- | :--- |\n";
            let hasFailures = false;

            try {
              const qStart = JSON.parse(execSync(`curl -s -H "Authorization: token ${token}" https://api.github.com/rate_limit`).toString()).resources.core;
              
              let allRepos = [];
              for (let page = 1; page <= 30; page++) {
                const cmd = `curl -s -H "Authorization: token ${token}" "https://api.github.com/user/repos?per_page=100&page=${page}&affiliation=owner"`;
                const part = JSON.parse(execSync(cmd).toString());
                if (!Array.isArray(part) || part.length === 0) break;
                allRepos = allRepos.concat(part);
              }

              const targetForks = allRepos.filter(f => f.fork === true);
              const totalToProcess = targetForks.length;
              console.log(`Starting sync for ${totalToProcess} forks...`);

              for (let i = 0; i < totalToProcess; i++) {
                // Safety: Stop if we hit too many errors in a row
                if (stats.consecutiveFailures >= 10) {
                  console.error("Stopping: Hit 10 consecutive failures. Check token/network.");
                  break;
                }

                const fork = targetForks[i];
                stats.total++;
                const name = fork.full_name;
                
                try {
                  // 1. Safety Code (Size Check)
                  const repoData = JSON.parse(execSync(`curl -s -H "Authorization: token ${token}" https://api.github.com/repos/${name}`).toString());
                  if (repoData.parent && repoData.parent.size < (fork.size / 2) && fork.size > 100) {
                    stats.blocked++;
                    stats.consecutiveFailures = 0;
                    continue;
                  }

                  // 2. Sync Attempt
                  const syncCmd = `curl -s -X POST -H "Authorization: token ${token}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${name}/merge-upstream -d '{"branch":"${fork.default_branch}"}'`;
                  const result = JSON.parse(execSync(syncCmd).toString());
                  
                  if (result.message && result.message.includes("Successfully merged")) {
                    tableRows += `| ${name} | âœ… Synced | Updated |\n`;
                    stats.synced++;
                    stats.consecutiveFailures = 0;
                  } else {
                    stats.upToDate++;
                    stats.consecutiveFailures = 0;
                  }
                } catch (e) {
                  stats.failed++;
                  stats.consecutiveFailures++;
                }
                
                if (stats.total % 50 === 0) {
                  const percent = Math.round((stats.total / totalToProcess) * 100);
                  console.log(`Progress: ${percent}% (${stats.total}/${totalToProcess})`);
                }
                await new Promise(r => setTimeout(r, 60)); 
              }

              const qEnd = JSON.parse(execSync(`curl -s -H "Authorization: token ${token}" https://api.github.com/rate_limit`).toString()).resources.core;
              let summary = `### ðŸ“Š API Quota\n- **Used:** ${qStart.remaining - qEnd.remaining} points\n- **Remaining:** ${qEnd.remaining}\n\n`;
              summary += `### ðŸ”„ Sync Activity Report\n- **Total Forks:** ${stats.total}\n- **Synced:** ${stats.synced} | **Up-to-Date:** ${stats.upToDate} | **Blocked:** ${stats.blocked} | **Failed:** ${stats.failed}\n\n`;
              
              if (stats.synced > 0 || stats.blocked > 0) summary += "#### âœ… Notable Changes\n" + tableRows;
              
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
            } catch (err) {
              process.exit(1);
            }
          }
          run();
          EOF
          node sync.js
