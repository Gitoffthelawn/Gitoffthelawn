name: Safe Sync Forks

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    steps:
      - name: Sync All Forks
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          cat << 'EOF' > sync.js
          const { execSync } = require('child_process');
          const fs = require('fs');

          async function run() {
            let stats = { total: 0, synced: 0, noChange: 0, blocked: 0, failed: 0 };
            let tableRows = "| Repository | Status | Details |\n| :--- | :--- | :--- |\n";
            let failureLog = "\n### ‚ö†Ô∏è Failure Details\n| Repository | Error Message |\n| :--- | :--- |\n";
            let hasFailures = false;

            try {
              // 1. IDENTITY PROBE
              console.log("Probing token identity...");
              const userResp = execSync('gh api user').toString();
              const user = JSON.parse(userResp);
              
              // This captures the raw headers to see exactly what permissions GitHub says this token has
              const headers = execSync('gh api -i user').toString();
              const scopesMatch = headers.match(/x-oauth-scopes:\s*(.*)/i);
              const scopes = scopesMatch ? scopesMatch[1].trim() : "NONE FOUND";

              let header = `### üë§ Token Identity Check\n`;
              header += `- **Authenticated as:** \`${user.login}\`\n`;
              header += `- **Detected Scopes:** \`${scopes}\`\n\n`;

              console.log(`Authenticated as: ${user.login} with scopes: ${scopes}`);

              // 2. FETCH REPOS (Aggressive Scan)
              // We'll try to fetch with no filters first to see what is visible
              execSync(`gh api "user/repos?per_page=100&affiliation=owner&visibility=all" --paginate > forks_raw.json`);
              
              const rawData = fs.readFileSync('forks_raw.json', 'utf8').trim();
              const sanitized = "[" + rawData.replace(/\]\s*\[/g, ',') + "]";
              const allRepos = JSON.parse(sanitized);
              const targetForks = allRepos.filter(f => f.fork === true);

              if (targetForks.length === 0) {
                header += `### üîÑ Sync Activity Report\n- **Total Repos Found:** ${allRepos.length}\n- **Total Forks Found:** 0\n\n`;
                header += `**Diagnostic:** The API sees these repos: \`${allRepos.slice(0,3).map(r => r.full_name).join(', ') || 'None'}\`\n\n`;
                header += `**Troubleshooting:** If the username above is correct but you see 0 forks, click your profile pic > Settings > Developer Settings > Personal Access Tokens (classic) > Click your token name > Ensure the **repo** box is fully checked.`;
                fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, header);
                return;
              }

              // 3. PROCESS FORKS
              for (const fork of targetForks) {
                stats.total++;
                const name = fork.full_name;
                try {
                  const parentData = JSON.parse(execSync(`gh api "repos/${name}" --silent`).toString());
                  if (parentData.parent) {
                    const syncOut = execSync(`gh repo sync "${name}" --force=false 2>&1`).toString();
                    if (syncOut.includes("already up to date")) stats.noChange++;
                    else {
                      tableRows += `| ${name} | ‚úÖ Synced | Updated |\n`;
                      stats.synced++;
                    }
                  }
                } catch (e) { stats.failed++; }
                if (stats.total % 100 === 0) console.log(`Processed ${stats.total}...`);
                await new Promise(r => setTimeout(r, 100));
              }

              // 4. FINAL SUMMARY
              let summary = header + `### üîÑ Sync Activity Report\n` +
                `- **Total Forks:** ${stats.total}\n` +
                `- **Synced:** ${stats.synced} | **Blocked:** ${stats.blocked} | **Errors:** ${stats.failed}\n\n`;
              if (stats.synced > 0) summary += tableRows;
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);

            } catch (err) {
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `### ‚ùå Fatal Error\n${err.message}`);
              process.exit(1);
            }
          }
          run();
          EOF
          node sync.js
