name: Safe Sync Forks

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    steps:
      - name: Sync All Forks
        env:
          MY_PAT: ${{ secrets.SYNC_TOKEN }}
        run: |
          cat << 'EOF' > sync.js
          const { execSync } = require('child_process');
          const fs = require('fs');

          async function run() {
            const token = process.env.MY_PAT;
            let stats = { total: 0, synced: 0, upToDate: 0, blocked: 0, failed: 0 };
            let tableRows = "| Repository | Status | Details |\n| :--- | :--- | :--- |\n";
            let failureLog = "\n### ‚ö†Ô∏è Failure Details\n| Repository | Error Message |\n| :--- | :--- |\n";
            let hasFailures = false;

            try {
              // 1. Quota Check (Start)
              const qStart = JSON.parse(execSync(`curl -s -H "Authorization: token ${token}" https://api.github.com/rate_limit`).toString()).resources.core;

              console.log("Fetching all owned repositories...");
              let allRepos = [];
              for (let page = 1; page <= 25; page++) {
                const cmd = `curl -s -H "Authorization: token ${token}" "https://api.github.com/user/repos?per_page=100&page=${page}&affiliation=owner"`;
                const part = JSON.parse(execSync(cmd).toString());
                if (!Array.isArray(part) || part.length === 0) break;
                allRepos = allRepos.concat(part);
              }

              const targetForks = allRepos.filter(f => f.fork === true);
              console.log(`Found ${targetForks.length} forks. Analyzing and Syncing...`);

              for (const fork of targetForks) {
                stats.total++;
                const name = fork.full_name;
                
                try {
                  // 2. THE SAFETY CODE (Protect against obliterated upstreams)
                  const repoData = JSON.parse(execSync(`curl -s -H "Authorization: token ${token}" https://api.github.com/repos/${name}`).toString());
                  const parent = repoData.parent;

                  if (parent) {
                    const mySize = fork.size;
                    const parentSize = parent.size;
                    
                    // Safety logic: If parent is < 50% of fork size, it's likely been wiped
                    if (parentSize < (mySize / 2) && mySize > 100) {
                      tableRows += `| ${name} | üõë **BLOCKED** | Safety: Parent size (${parentSize}KB) < 50% of fork (${mySize}KB) |\n`;
                      stats.blocked++;
                      continue; 
                    }
                  } else {
                    failureLog += `| ${name} | Upstream parent no longer exists or is private |\n`;
                    stats.failed++;
                    hasFailures = true;
                    continue;
                  }

                  // 3. Sync Attempt
                  const syncCmd = `curl -s -X POST -H "Authorization: token ${token}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${name}/merge-upstream -d '{"branch":"${fork.default_branch}"}'`;
                  const result = JSON.parse(execSync(syncCmd).toString());
                  
                  if (result.message && result.message.includes("Successfully merged")) {
                    tableRows += `| ${name} | ‚úÖ Synced | New changes merged |\n`;
                    stats.synced++;
                  } else if (result.message && (result.message.includes("already up to date") || result.message.includes("nothing to fetch"))) {
                    stats.upToDate++;
                  } else {
                    failureLog += `| ${name} | ${result.message || "Conflict or Branch issue"} |\n`;
                    stats.failed++;
                    hasFailures = true;
                  }
                } catch (e) {
                  stats.failed++;
                }
                
                if (stats.total % 100 === 0) console.log(`Progress: ${stats.total}/${targetForks.length}`);
                await new Promise(r => setTimeout(r, 50)); // Prevent secondary rate limits
              }

              // 4. Final Quota & Summary
              const qEnd = JSON.parse(execSync(`curl -s -H "Authorization: token ${token}" https://api.github.com/rate_limit`).toString()).resources.core;

              let finalSummary = `### üìä API Quota Status\n`;
              finalSummary += `- **Starting Quota:** ${qStart.remaining}\n`;
              finalSummary += `- **Ending Quota:** ${qEnd.remaining} (Used: ${qStart.remaining - qEnd.remaining})\n\n`;

              finalSummary += `### üîÑ Sync Activity Report\n` +
                `- **Total Forks Processed:** ${stats.total}\n` +
                `- **Successfully Synced:** ${stats.synced}\n` +
                `- **Already Up-to-Date:** ${stats.upToDate}\n` +
                `- **Safety Blocked:** ${stats.blocked}\n` +
                `- **Errors/Conflicts:** ${stats.failed}\n\n`;

              if (stats.synced > 0 || stats.blocked > 0) {
                finalSummary += "#### ‚úÖ Notable Changes\n" + tableRows + "\n\n";
              } else {
                finalSummary += "_All repositories were verified as synchronized._\n\n";
              }

              if (hasFailures) finalSummary += failureLog;
              
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, finalSummary);

            } catch (err) {
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `### ‚ùå Fatal Error\n${err.message}`);
              process.exit(1);
            }
          }
          run();
          EOF
          node sync.js
