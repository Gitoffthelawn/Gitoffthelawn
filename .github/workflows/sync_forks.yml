name: Safe Sync Forks

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    steps:
      - name: Sync All Forks
        env:
          MY_PAT: ${{ secrets.SYNC_TOKEN }}
        run: |
          cat << 'EOF' > sync.js
          const { execSync } = require('child_process');
          const fs = require('fs');

          async function run() {
            const token = process.env.MY_PAT;
            let stats = { total: 0, synced: 0, noChange: 0, failed: 0 };
            let tableRows = "| Repository | Status | Details |\n| :--- | :--- | :--- |\n";

            try {
              console.log("Fetching repos via raw HTTPS request...");
              
              // We use a raw curl command to ensure no CLI interference
              // This fetches up to 1000 repos in the first page (GitHub limit is usually 100 per page, so we loop)
              let allRepos = [];
              for (let page = 1; page <= 20; page++) {
                const cmd = `curl -s -H "Authorization: token ${token}" "https://api.github.com/user/repos?per_page=100&page=${page}&affiliation=owner"`;
                const output = execSync(cmd).toString();
                const part = JSON.parse(output);
                if (part.length === 0) break;
                allRepos = allRepos.concat(part);
                console.log(`Page ${page}: found ${part.length} repos...`);
              }

              const targetForks = allRepos.filter(f => f.fork === true);
              console.log(`Total Forks Found: ${targetForks.length}`);

              if (targetForks.length === 0) {
                const diag = `### üîÑ Sync Activity Report\n- **Total Repos Found:** ${allRepos.length}\n- **Total Forks Found:** 0\n\n**Sample:** \`${allRepos.slice(0,2).map(r => r.full_name).join(', ')}\``;
                fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, diag);
                return;
              }

              for (const fork of targetForks) {
                stats.total++;
                const name = fork.full_name;
                try {
                  // Attempt sync using the token explicitly
                  const syncCmd = `curl -s -X POST -H "Authorization: token ${token}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/${name}/merge-upstream -d '{"branch":"${fork.default_branch}"}'`;
                  const result = JSON.parse(execSync(syncCmd).toString());
                  
                  if (result.message && result.message.includes("Successfully merged")) {
                    tableRows += `| ${name} | ‚úÖ | Synced |\n`;
                    stats.synced++;
                  } else {
                    stats.noChange++;
                  }
                } catch (e) {
                  stats.failed++;
                }
                if (stats.total % 100 === 0) console.log(`Processed ${stats.total}...`);
              }

              const summary = `### üîÑ Sync Activity Report\n- **Total Forks:** ${stats.total}\n- **Synced:** ${stats.synced}\n\n${tableRows}`;
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);

            } catch (err) {
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `### ‚ùå Error\n${err.message}`);
              process.exit(1);
            }
          }
          run();
          EOF
          node sync.js
