name: Safe Sync Forks

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    steps:
      - name: Sync and Detect Fork Status
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          # Initialize temporary storage
          echo "| Repository | Status | Details |" > table_body.md
          echo "| :--- | :--- | :--- |" >> table_body.md
          echo "TOTAL=0; SYNCED=0; NO_CHANGE=0; BLOCKED=0; FAILED=0" > counts.tmp

          # 1. Fetch ALL forks with a retry loop for the initial call
          # We use a simple while loop to handle pagination manually to be safer against 502s
          cursor="null"
          has_next_page=true

          while [ "$has_next_page" = true ]; do
            echo "Fetching page of forks (cursor: $cursor)..."
            
            # Use 'gh api' with a retry flag and a timeout
            page_data=$(gh api graphql --retry 3 -f cursor="$cursor" -f query='
              query($cursor: String) {
                viewer {
                  repositories(first: 50, isFork: true, after: $cursor) {
                    nodes {
                      nameWithOwner
                      diskUsage
                      defaultBranchRef { name }
                      parent {
                        nameWithOwner
                        diskUsage
                      }
                    }
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                  }
                }
              }
            ') || { echo "GitHub API failed after retries. Exiting."; exit 1; }

            # 2. Process the current page
            echo "$page_data" | jq -c '.data.viewer.repositories.nodes[]' | while read -r repo; do
              # Load counters
              source counts.tmp
              ((TOTAL++))
              
              NAME=$(echo $repo | jq -r '.nameWithOwner')
              MY_SIZE=$(echo $repo | jq -r '.diskUsage')
              PARENT_NAME=$(echo $repo | jq -r '.parent.nameWithOwner // "null"')
              PARENT_SIZE=$(echo $repo | jq -r '.parent.diskUsage // 0')
              
              if [ "$PARENT_NAME" == "null" ]; then
                echo "| $NAME | âš ï¸ Skipped | Parent repo no longer exists |" >> table_body.md
                ((FAILED++))
              else
                # Sanity Check: Mass deletion
                THRESHOLD=$((MY_SIZE / 2))
                if [ "$PARENT_SIZE" -lt "$THRESHOLD" ] && [ "$MY_SIZE" -gt 100 ]; then
                  echo "| $NAME | ðŸ›‘ **BLOCKED** | Size Trigger: Parent ${PARENT_SIZE}KB vs Fork ${MY_SIZE}KB |" >> table_body.md
                  ((BLOCKED++))
                else
                  # Sync Attempt
                  SYNC_OUTPUT=$(gh repo sync "$NAME" --force=false 2>&1)
                  if [ $? -eq 0 ]; then
                    if echo "$SYNC_OUTPUT" | grep -q "already up to date"; then
                      echo "| $NAME | âœ¨ No Change | Fork is newer or equal to parent |" >> table_body.md
                      ((NO_CHANGE++))
                    else
                      echo "| $NAME | âœ… Synced | Successfully updated |" >> table_body.md
                      ((SYNCED++))
                    fi
                  else
                    echo "| $NAME | âŒ Failed | Merge conflict detected |" >> table_body.md
                    ((FAILED++))
                  fi
                fi
              fi
              # Save counters
              echo "TOTAL=$TOTAL; SYNCED=$SYNCED; NO_CHANGE=$NO_CHANGE; BLOCKED=$BLOCKED; FAILED=$FAILED" > counts.tmp
            done

            # Update pagination variables
            has_next_page=$(echo "$page_data" | jq -r '.data.viewer.repositories.pageInfo.hasNextPage')
            cursor=$(echo "$page_data" | jq -r '.data.viewer.repositories.pageInfo.endCursor')
          done

          # 3. Build Final Summary
          source counts.tmp
          echo "### ðŸ“Š Sync Activity Report" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Forks Processed:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Successfully Synced:** $SYNCED" >> $GITHUB_STEP_SUMMARY
          echo "- **Already Up-to-Date/Newer:** $NO_CHANGE" >> $GITHUB_STEP_SUMMARY
          echo "- **Blocked by Sanity Check:** $BLOCKED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed/Conflicts:** $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat table_body.md >> $GITHUB_STEP_SUMMARY
